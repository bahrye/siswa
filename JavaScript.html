<script>
  let currentNpsn = "";
  let selectedNisn = "";
  let sessionSchoolID = "";
  
  // Variabel Global
  let globalStudentData = []; // Data Admin
  let globalPublicData = [];  // Data Publik

  // Variabel Cache Kode Akses (Session)
  let cachedAccessCode = ""; 

  // --- [BARU] FUNGSI CEK SESI SAAT RELOAD ---
  document.addEventListener('DOMContentLoaded', function() {
    checkSession();
  });

  function checkSession() {
    // 1. Cek Sesi Admin
    const adminSession = localStorage.getItem('eduDataAdmin');
    if (adminSession) {
      const sess = JSON.parse(adminSession);
      
      // Restore Variabel
      sessionSchoolID = sess.sekolahID;
      
      // Restore UI Dashboard Admin
      document.getElementById('formSekolahID').value = sess.sekolahID;
      document.getElementById('dashSchoolName').innerText = sess.namaSekolah;
      document.getElementById('dashAccessCode').innerText = sess.accessCode;
      
      // Pindah Tampilan
      document.getElementById('viewLanding').classList.add('d-none');
      document.getElementById('viewPublicList').classList.add('d-none'); // Pastikan publik hidden
      document.getElementById('viewAdminAuth').classList.add('d-none');
      document.getElementById('viewAdminDashboard').classList.remove('d-none');
      document.getElementById('btnLogout').classList.remove('d-none');
      document.getElementById('btnAdminLink').classList.add('d-none');
      
      // Load Data
      loadAdminData();
      return; // Stop agar tidak bentrok dengan sesi publik
    }

    // 2. Cek Sesi Publik (NPSN)
    const publicNpsn = localStorage.getItem('eduDataPublicNPSN');
    if (publicNpsn) {
      document.getElementById('inputNpsn').value = publicNpsn;
      
      // Jika sebelumnya sudah memasukkan kode akses (unlocked)
      const savedCode = localStorage.getItem('eduDataAccessCode');
      if (savedCode) {
        cachedAccessCode = savedCode;
      }

      searchByNPSN(); // Otomatis cari ulang
    }
  }

  // --- CUSTOM SORTING HELPER ---
  
  // Fungsi menerjemahkan Angka Romawi ke Angka Biasa
  function decodeRoman(roman) {
    const vals = {I:1, V:5, X:10, L:50, C:100};
    let num = 0;
    for (let i = 0; i < roman.length; i++) {
      let curr = vals[roman[i]] || 0;
      let next = vals[roman[i+1]] || 0;
      if (next > curr) num -= curr;
      else num += curr;
    }
    return num;
  }

  // Fungsi memecah nama kelas menjadi Level (Angka) dan Suffix (sisanya)
  function parseClassLevel(name) {
    if (!name) return { level: 9999, suffix: "" };
    
    // Hapus awalan umum seperti "Kelas", "Kls", dll
    let clean = name.replace(/^(kelas|kls)\.?\s*/i, "").trim();
    
    // Cek apakah diawali Angka (7, 8, 9, 10...)
    let matchDigit = clean.match(/^(\d+)/);
    if (matchDigit) {
      return {
        level: parseInt(matchDigit[1]),
        suffix: clean.substring(matchDigit[1].length).trim()
      };
    }

    // Cek apakah diawali Romawi (VII, VIII, IX, X...)
    let matchRoman = clean.match(/^([IVXLC]+)(?=[^a-zA-Z]|$)/i);
    if (matchRoman) {
      return {
        level: decodeRoman(matchRoman[1].toUpperCase()),
        suffix: clean.substring(matchRoman[1].length).trim()
      };
    }

    // Jika format lain, taruh di urutan akhir
    return { level: 9999, suffix: clean };
  }

  // Fungsi Utama Pengurutan (Kelas -> Jurusan -> Nama Siswa)
  function compareDataSiswa(a, b) {
    let rA = parseClassLevel(a.rombel);
    let rB = parseClassLevel(b.rombel);

    // Prioritas 1: Level Kelas (Kecil ke Besar)
    if (rA.level !== rB.level) {
      return rA.level - rB.level;
    }

    // Prioritas 2: Detail Kelas (IPA 1, IPA 2, A, B...)
    // 'numeric: true' memastikan "IPA 2" lebih dulu daripada "IPA 10"
    const suffixCompare = rA.suffix.localeCompare(rB.suffix, undefined, {numeric: true, sensitivity: 'base'});
    if (suffixCompare !== 0) {
      return suffixCompare;
    }

    // Prioritas 3: Nama Siswa (A-Z)
    // Dijalankan hanya jika Level dan Detail Kelas sama persis
    return a.nama.localeCompare(b.nama, undefined, {sensitivity: 'base'});
  }

  // --- NAVIGATION & UTILS ---
  function showAdminLogin() {
    document.getElementById('viewLanding').classList.add('d-none');
    document.getElementById('viewPublicList').classList.add('d-none');
    document.getElementById('viewAdminAuth').classList.remove('d-none');
    document.getElementById('btnAdminLink').classList.add('d-none');
  }

  function resetView() {
    document.getElementById('viewLanding').classList.remove('d-none');
    document.getElementById('viewPublicList').classList.add('d-none');
    document.getElementById('viewAdminAuth').classList.add('d-none');
    document.getElementById('btnAdminLink').classList.remove('d-none');
    
    // Reset Data & Cache saat kembali ke menu awal
    document.getElementById('inputNpsn').value = "";
    currentNpsn = "";
    globalPublicData = [];
    cachedAccessCode = ""; // Hapus akses saat keluar dari halaman list
    
    // Bersihkan sesi publik dari storage juga saat manual back
    localStorage.removeItem('eduDataPublicNPSN');
    localStorage.removeItem('eduDataAccessCode');
  }
  
  function toggleAuth(type) {
    if(type==='register'){
       document.getElementById('loginPanel').classList.add('d-none');
       document.getElementById('registerPanel').classList.remove('d-none');
    } else {
       document.getElementById('registerPanel').classList.add('d-none');
       document.getElementById('loginPanel').classList.remove('d-none');
    }
  }

  // --- HELPERS ---
  function hitungUmur() {
    const dob = document.getElementById('inputTglLahir').value;
    if(dob) {
      const birthDate = new Date(dob);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
      document.getElementById('inputUmur').value = age;
    }
  }

  function calculateAgeString(dobString) {
    if (!dobString) return "-";
    const birthDate = new Date(dobString);
    if(isNaN(birthDate)) return "-"; // Validasi tanggal
    
    const today = new Date();
    
    let years = today.getFullYear() - birthDate.getFullYear();
    let months = today.getMonth() - birthDate.getMonth();
    
    if (months < 0 || (months === 0 && today.getDate() < birthDate.getDate())) {
      years--;
      months += 12;
    }
    if (today.getDate() < birthDate.getDate()) {
      months--;
      if(months < 0) months += 12;
    }
    
    return `${years} th, ${months} bln`;
  }
  
  function getAgeYearOnly(dobString) {
     if (!dobString) return 0;
     const birthDate = new Date(dobString);
     const today = new Date();
     let age = today.getFullYear() - birthDate.getFullYear();
     const m = today.getMonth() - birthDate.getMonth();
     if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
     return age;
  }
  
  function getStatusBadgeClass(status) {
    if (status === 'Aktif') return 'bg-success';
    if (status === 'Lulus') return 'bg-info';
    if (status === 'Pindah') return 'bg-danger';
    return 'bg-secondary';
  }

  function logout() {
    Swal.fire({ title: 'Logging out...', timer: 800, didOpen: () => Swal.showLoading() });
    
    // --- [BARU] HAPUS SESI DARI BROWSER ---
    localStorage.removeItem('eduDataAdmin');
    localStorage.removeItem('eduDataPublicNPSN');
    localStorage.removeItem('eduDataAccessCode');
    // --------------------------------------

    sessionSchoolID = "";
    currentNpsn = "";
    globalStudentData = [];
    cachedAccessCode = "";
    
    document.getElementById('viewAdminDashboard').classList.add('d-none');
    document.getElementById('viewAdminAuth').classList.add('d-none'); 
    document.getElementById('viewLanding').classList.remove('d-none');
    document.getElementById('viewPublicList').classList.add('d-none');
    
    document.getElementById('btnLogout').classList.add('d-none');
    document.getElementById('btnAdminLink').classList.remove('d-none');
    
    document.getElementById('username').value = "";
    document.getElementById('password').value = "";
    document.getElementById('adminTableBody').innerHTML = "";
    document.getElementById('inputNpsn').value = ""; // Reset input NPSN
  }

  // --- 1. PUBLIC SEARCH & FILTERING ---
  
  function searchByNPSN() {
    const npsn = document.getElementById('inputNpsn').value;
    if(!npsn) return Swal.fire('Error','Masukkan NPSN dulu','warning');
    
    // --- [BARU] SIMPAN NPSN TERAKHIR ---
    localStorage.setItem('eduDataPublicNPSN', npsn);
    // -----------------------------------
    
    Swal.fire({title:'Mencari Sekolah...', didOpen:()=>Swal.showLoading()});
    google.script.run.withSuccessHandler(res => {
      Swal.close();
      if(res.found) {
        res.data.sort(compareDataSiswa);
        currentNpsn = npsn;
        document.getElementById('publicSchoolName').innerText = res.namaSekolah;
        document.getElementById('publicNpsnBadge').innerText = "NPSN: " + npsn;
        
        globalPublicData = res.data;
        
        // Reset Filter Dropdown
        const uniqueRombel = [...new Set(res.data.map(item => item.rombel))].sort();
        const selRombel = document.getElementById('pubFilterRombel');
        selRombel.innerHTML = '<option value="">Semua Kelas</option>';
        uniqueRombel.forEach(r => {
          if(r) selRombel.innerHTML += `<option value="${r}">${r}</option>`;
        });

        document.getElementById('viewLanding').classList.add('d-none');
        document.getElementById('viewPublicList').classList.remove('d-none');
        applyPublicFilter(); // Render Tabel

      } else {
        Swal.fire('Tidak Ditemukan', res.message, 'error');
      }
    }).getSchoolByNPSN(npsn);
  }

  function applyPublicFilter() {
    const fRombel = document.getElementById('pubFilterRombel').value;
    const fStatus = document.getElementById('pubFilterStatus').value;
    const fJK = document.getElementById('pubFilterJK').value;
    const fMin = document.getElementById('pubFilterUmurMin').value;
    const fMax = document.getElementById('pubFilterUmurMax').value;

    const filtered = globalPublicData.filter(row => {
      const matchRombel = fRombel === "" || row.rombel == fRombel;
      const matchStatus = fStatus === "" || row.status == fStatus;
      const matchJK = fJK === "" || row.jk == fJK;
      
      const umurTahun = getAgeYearOnly(row.tglLahir);
      let matchUmur = true;
      if (fMin !== "" && umurTahun < parseInt(fMin)) matchUmur = false;
      if (fMax !== "" && umurTahun > parseInt(fMax)) matchUmur = false;

      return matchRombel && matchStatus && matchJK && matchUmur;
    });

    renderPublicTable(filtered);
    updatePublicSummary(filtered, fRombel, fStatus);
  }

  function updatePublicSummary(data, rombel, status) {
    let labelParts = [];
    labelParts.push(rombel ? `Kelas: ${rombel}` : "Semua Kelas");
    if (status) labelParts.push(`Status: ${status}`);
    
    document.getElementById('pubSumLabelFilter').innerText = "Filter: " + labelParts.join(", ");
    
    const countL = data.filter(d => d.jk === 'L').length;
    const countP = data.filter(d => d.jk === 'P').length;
    
    document.getElementById('pubSumCountL').innerText = countL;
    document.getElementById('pubSumCountP').innerText = countP;
    document.getElementById('pubSumCountTotal').innerText = data.length;
  }

  function renderPublicTable(data) {
    const tbody = document.getElementById('publicTableBody');
    tbody.innerHTML = '';
    
    if(data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4">Data tidak ditemukan sesuai filter.</td></tr>';
      return;
    }
    
    data.forEach((row, index) => {
      let badge = getStatusBadgeClass(row.status);
      let displayNISN = "";
      let displayAge = "";
      
      // --- LOGIKA MASKING vs UNMASKING ---
      if (cachedAccessCode !== "") {
          // JIKA SUDAH PUNYA AKSES: Tampilkan DATA ASLI
          displayNISN = `<span class="text-dark font-monospace">${row.nisn}</span>`;
          displayAge = calculateAgeString(row.tglLahir);
      } else {
          // JIKA BELUM PUNYA AKSES: Tampilkan SENSOR BINTANG
          let nisnStr = row.nisn.toString();
          let masked = nisnStr.length > 6 ? nisnStr.substring(0, nisnStr.length - 6) + "******" : "******";
          displayNISN = `<span class="text-muted font-monospace">${masked}</span>`;
          displayAge = '<span class="text-muted">** Th</span>';
      }

      tbody.innerHTML += `
        <tr>
          <td class="ps-3">${index + 1}</td>
          <td class="fw-bold">${row.nama}</td>
          <td>${displayNISN}</td>
          <td>${row.rombel}</td>
          <td>${row.jk || '-'}</td>
          <td>${displayAge}</td>
          <td><span class="badge ${badge} status-badge">${row.status}</span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-warning text-white rounded-circle shadow-sm" onclick="promptCode('${row.nisn}')" title="Buka Detail">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        </tr>`;
    });
  }

  // --- 2. SECURE DETAIL VIEW ---
  function promptCode(nisn) {
    selectedNisn = nisn;
    
    // Jika Cache Kode Ada, Langsung Eksekusi tanpa Modal
    if (cachedAccessCode !== "") {
       executeVerification(cachedAccessCode);
    } else {
       document.getElementById('inputAccessCode').value = "";
       new bootstrap.Modal(document.getElementById('accessCodeModal')).show();
    }
  }

  function verifyCode() {
    const code = document.getElementById('inputAccessCode').value;
    if(code.length < 8) return Swal.fire('Error', 'Kode harus 8 karakter', 'warning');
    
    bootstrap.Modal.getInstance(document.getElementById('accessCodeModal')).hide();
    executeVerification(code);
  }
  
  function executeVerification(code) {
    Swal.fire({title:'Memverifikasi...', didOpen:()=>Swal.showLoading()});
    
    google.script.run.withSuccessHandler(res => {
      Swal.close();
      if(res.success) {
        // SUKSES: Simpan Kode & Refresh Tabel untuk Buka Sensor
        cachedAccessCode = code; 
        
        // --- [BARU] SIMPAN KODE AKSES KE STORAGE ---
        localStorage.setItem('eduDataAccessCode', code);
        // -------------------------------------------
        
        // 1. Tampilkan Modal Detail Siswa yg dipilih (Hanya jika ada selectedNisn aktif)
        if(selectedNisn) {
           showDetailModal(res.data);
        }
        
        // 2. Refresh Tabel Publik (agar bintang-bintang hilang di semua baris)
        applyPublicFilter(); 

      } else {
        // GAGAL: Reset Cache
        cachedAccessCode = ""; 
        localStorage.removeItem('eduDataAccessCode'); // Hapus jika salah
        Swal.fire('Akses Ditolak', res.message, 'error');
      }
    }).verifyAndGetDetail(currentNpsn, selectedNisn || "000", code);
  }

  function showDetailModal(s) {
    let badge = getStatusBadgeClass(s.status);
    const ageDetail = calculateAgeString(s.tglLahir);
    
    const html = `
      <div class="table-responsive">
        <table class="table table-bordered mb-0 align-middle">
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-user me-2"></i>Identitas Pribadi (Terbuka)</th></tr></thead>
          <tr><td width="35%" class="text-muted fw-bold ps-3">Nama Lengkap</td><td class="fw-bold fs-5">${s.nama}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">NISN</td><td class="fw-bold text-dark">${s.nisn} <i class="fas fa-check-circle text-success small ms-1"></i></td></tr>
          <tr><td class="text-muted fw-bold ps-3">NIK</td><td>${s.nik || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Jenis Kelamin</td><td>${s.jk === 'L' ? 'Laki-laki' : 'Perempuan'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">TTL (Umur)</td><td>${s.tempatLahir}, ${s.tglLahir} <br><span class="badge bg-primary">${ageDetail}</span></td></tr>
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-school me-2"></i>Data Sekolah</th></tr></thead>
          <tr><td class="text-muted fw-bold ps-3">Kelas / Rombel</td><td>${s.rombel}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Status Siswa</td><td><span class="badge ${badge} rounded-pill px-3">${s.status}</span></td></tr>
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-file-medical me-2"></i>Data Tambahan</th></tr></thead>
          <tr><td class="text-muted fw-bold ps-3">Nomor KIP</td><td>${s.kip || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Kebutuhan Khusus</td><td>${s.kebKhusus || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Disabilitas</td><td>${s.disabilitas || '-'}</td></tr>
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-map-marker-alt me-2"></i>Alamat & Kontak</th></tr></thead>
          <tr><td class="text-muted fw-bold ps-3">Alamat Lengkap</td><td>${s.alamat}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">No. Telepon</td><td>${s.telp || '-'}</td></tr>
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-users me-2"></i>Orang Tua / Wali</th></tr></thead>
          <tr><td class="text-muted fw-bold ps-3">Nama Ayah</td><td>${s.ayah || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Nama Ibu</td><td>${s.ibu || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Nama Wali</td><td>${s.wali || '-'}</td></tr>
        </table>
      </div>`;
      
    document.getElementById('detailContent').innerHTML = html;
    new bootstrap.Modal(document.getElementById('detailModal')).show();
  }

  // --- 3. ADMIN LOGIC (Standard) ---
  function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    Swal.fire({title:'Login...', didOpen:()=>Swal.showLoading()});
    
    google.script.run.withSuccessHandler(res => {
      Swal.close();
      if(res.status === 'success') {
        // --- [BARU] SIMPAN SESI KE LOCALSTORAGE ---
        const sessionData = {
          sekolahID: res.sekolahID,
          namaSekolah: res.namaSekolah,
          accessCode: res.accessCode
        };
        localStorage.setItem('eduDataAdmin', JSON.stringify(sessionData));
        // ------------------------------------------

        sessionSchoolID = res.sekolahID;
        document.getElementById('formSekolahID').value = res.sekolahID;
        document.getElementById('dashSchoolName').innerText = res.namaSekolah;
        document.getElementById('dashAccessCode').innerText = res.accessCode;
        
        document.getElementById('viewAdminAuth').classList.add('d-none');
        document.getElementById('viewAdminDashboard').classList.remove('d-none');
        document.getElementById('btnLogout').classList.remove('d-none');
        document.getElementById('btnAdminLink').classList.add('d-none'); // Sembunyikan tombol admin link
        
        loadAdminData();
      } else Swal.fire('Gagal', 'Username/Password salah', 'error');
    }).loginAdmin(u, p);
  }

  function handleRegister(e) {
    e.preventDefault();
    Swal.fire({title:'Mendaftarkan...', didOpen:()=>Swal.showLoading()});
    google.script.run.withSuccessHandler(res=>{
      Swal.close();
      if(res.status==='success'){
        Swal.fire('Sukses',res.message,'success');
        document.getElementById('formRegistrasi').reset();
        toggleAuth('login');
      } else Swal.fire('Gagal',res.message,'error');
    }).registrasiSekolah(document.getElementById('formRegistrasi'));
  }

  function loadAdminData() {
    Swal.fire({title:'Memuat Data...', didOpen:()=>Swal.showLoading()});
    google.script.run.withSuccessHandler(data => {
      Swal.close();
      data.sort(compareDataSiswa);
      globalStudentData = data;
      
      const uniqueRombel = [...new Set(data.map(item => item.rombel))].sort();
      const selRombel = document.getElementById('filterRombel');
      selRombel.innerHTML = '<option value="">Semua Kelas</option>';
      uniqueRombel.forEach(r => {
        if(r) selRombel.innerHTML += `<option value="${r}">${r}</option>`;
      });

      applyAdminFilter();
    }).getDataSiswa(sessionSchoolID);
  }

  function applyAdminFilter() {
    const fRombel = document.getElementById('filterRombel').value;
    const fStatus = document.getElementById('filterStatus').value;
    const fJK = document.getElementById('filterJK').value;
    const fMin = document.getElementById('filterUmurMin').value;
    const fMax = document.getElementById('filterUmurMax').value;

    const filtered = globalStudentData.filter(row => {
      const matchRombel = fRombel === "" || row.rombel == fRombel;
      const matchStatus = fStatus === "" || row.status == fStatus;
      const matchJK = fJK === "" || row.jk == fJK;
      const umurTahun = getAgeYearOnly(row.tglLahir);
      let matchUmur = true;
      if (fMin !== "" && umurTahun < parseInt(fMin)) matchUmur = false;
      if (fMax !== "" && umurTahun > parseInt(fMax)) matchUmur = false;
      return matchRombel && matchStatus && matchJK && matchUmur;
    });

    renderAdminTable(filtered);
    updateSummary(filtered, fRombel, fStatus);
  }

  function updateSummary(data, rombel, status) {
    let labelParts = [];
    labelParts.push(rombel ? `Kelas: ${rombel}` : "Semua Kelas");
    if (status) labelParts.push(`Status: ${status}`);
    document.getElementById('sumLabelFilter').innerText = "Filter: " + labelParts.join(", ");
    
    const countL = data.filter(d => d.jk === 'L').length;
    const countP = data.filter(d => d.jk === 'P').length;
    document.getElementById('sumCountL').innerText = countL;
    document.getElementById('sumCountP').innerText = countP;
    document.getElementById('sumCountTotal').innerText = data.length;
  }

  function renderAdminTable(data) {
    const tbody = document.getElementById('adminTableBody');
    tbody.innerHTML = '';
    
    if(data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Data tidak ditemukan.</td></tr>';
      document.getElementById('tableCounter').innerText = "";
      return;
    }

    data.forEach(r => {
      let badge = getStatusBadgeClass(r.status);
      
      // 1. Encode Data Lengkap untuk tombol View & Edit (PERBAIKAN: Escape kutip satu)
      const rowJson = encodeURIComponent(JSON.stringify(r)).replace(/'/g, "%27");

      // 2. Encode Nama Siswa khusus untuk tombol Hapus (PERBAIKAN: Escape kutip satu juga)
      const safeNama = encodeURIComponent(r.nama).replace(/'/g, "%27");
      
      const displayAge = calculateAgeString(r.tglLahir);

      tbody.innerHTML += `
        <tr>
          <td class="font-monospace">${r.nisn}</td>
          <td class="fw-bold">${r.nama}</td>
          <td>${r.jk}</td>
          <td>${displayAge}</td>
          <td>${r.rombel}</td>
          <td><span class="badge ${badge} status-badge">${r.status}</span></td>
          <td class="text-center">
             <button class="btn btn-sm btn-info text-white rounded-circle me-1" onclick="viewFromAdmin('${rowJson}')" title="Detail">
               <i class="fas fa-eye"></i>
             </button>
             <button class="btn btn-sm btn-warning text-white rounded-circle me-1" onclick="editFromAdmin('${rowJson}')" title="Edit">
               <i class="fas fa-pen"></i>
             </button>
             <button class="btn btn-sm btn-danger rounded-circle" onclick="deleteFromAdmin('${r.nisn}', '${safeNama}')" title="Hapus">
               <i class="fas fa-trash"></i>
             </button>
          </td>
        </tr>`;
    });
    document.getElementById('tableCounter').innerText = `Menampilkan ${data.length} siswa`;
  }

  function viewFromAdmin(jsonStr) {
    const data = JSON.parse(decodeURIComponent(jsonStr));
    showDetailModal(data);
  }

  function deleteFromAdmin(nisn, encodedNama) {
    // Decode nama agar kembali terbaca normal (misal: Ma%27ruf -> Ma'ruf)
    const nama = decodeURIComponent(encodedNama);

    Swal.fire({
      title: 'Hapus Data?',
      text: `Yakin menghapus siswa: ${nama}?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: 'Ya, Hapus!'
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({title:'Menghapus...', didOpen:()=>Swal.showLoading()});
        google.script.run.withSuccessHandler(res => {
          Swal.close();
          if(res.status === 'success') {
            Swal.fire('Terhapus!', res.message, 'success');
            loadAdminData();
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).hapusSiswa(sessionSchoolID, nisn);
      }
    });
  }

  function prepareAddModal() {
    document.getElementById('addStudentForm').reset();
    document.getElementById('formMode').value = "add";
    document.getElementById('formSekolahID').value = sessionSchoolID;
    document.querySelector('#addModal .modal-title').innerText = "Input Data Siswa Baru";
    new bootstrap.Modal(document.getElementById('addModal')).show();
  }

  function editFromAdmin(jsonStr) {
    const data = JSON.parse(decodeURIComponent(jsonStr));
    const form = document.getElementById('addStudentForm');
    
    document.getElementById('formMode').value = "edit";
    document.getElementById('oldNisn').value = data.nisn;
    document.getElementById('formSekolahID').value = sessionSchoolID;
    document.querySelector('#addModal .modal-title').innerText = "Edit Data Siswa";

    const keys = Object.keys(data);
    keys.forEach(key => {
       if(form.elements[key]) {
         form.elements[key].value = data[key];
       }
    });
    
    hitungUmur();
    const statusSelect = form.elements['status'];
    if(statusSelect) statusSelect.dispatchEvent(new Event('change'));

    new bootstrap.Modal(document.getElementById('addModal')).show();
  }

  function handleSaveStudent(e) {
    e.preventDefault();
    const mode = document.getElementById('formMode').value;
    const modalEl = document.getElementById('addModal');
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    
    modalInstance.hide();
    Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()});
    
    const formEl = document.getElementById('addStudentForm');

    if (mode === 'add') {
       google.script.run.withSuccessHandler(res => {
        Swal.close();
        Swal.fire('Berhasil', res, 'success');
        formEl.reset();
        loadAdminData();
      }).tambahSiswa(formEl);
    } else {
       google.script.run.withSuccessHandler(res => {
        Swal.close();
        Swal.fire('Berhasil Update', res, 'success');
        formEl.reset();
        loadAdminData();
      }).editSiswa(formEl);
    }
  }

  // --- 4. FITUR IMPORT EXCEL (BARU) ---

  function showImportModal() {
    document.getElementById('fileImportInput').value = "";
    document.getElementById('importPreview').innerText = "";
    new bootstrap.Modal(document.getElementById('importModal')).show();
  }

  // Fungsi 1: Download Template
  function downloadTemplate() {
    // Header sesuai permintaan
    const headers = [
      "No", "Nama Lengkap", "NISN", "NIK", "Tempat Lahir", 
      "Tanggal Lahir", "Tingkat - Rombel", "Umur", "Status", 
      "Jenis Kelamin", "Alamat", "No Telepon", "Kebutuhan Khusus", 
      "Disabilitas", "Nomor KIP/PIP", "Nama Ayah Kandung", 
      "Nama Ibu Kandung", "Nama Wali"
    ];

    // Data Contoh (Dummy)
    const sampleData = [
      {
        "No": 1, "Nama Lengkap": "Contoh Siswa", "NISN": "1234567890", "NIK": "3201234567890001",
        "Tempat Lahir": "Jakarta", "Tanggal Lahir": "2010-05-20", "Tingkat - Rombel": "X IPA 1",
        "Umur": "", "Status": "Aktif", "Jenis Kelamin": "Laki-laki", 
        "Alamat": "Jl. Contoh No. 1", "No Telepon": "'08123456789", 
        "Kebutuhan Khusus": "-", "Disabilitas": "-", "Nomor KIP/PIP": "-",
        "Nama Ayah Kandung": "Ayah Budi", "Nama Ibu Kandung": "Ibu Budi", "Nama Wali": "-"
      }
    ];

    const ws = XLSX.utils.json_to_sheet(sampleData, {header: headers});
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Template");
    
    // Trigger Download
    XLSX.writeFile(wb, "Template_Data_Siswa.xlsx");
  }

  // Fungsi 2: Proses Import
  function processImportFile() {
    const fileInput = document.getElementById('fileImportInput');
    if(!fileInput.files.length) {
      return Swal.fire('Error', 'Pilih file Excel terlebih dahulu', 'warning');
    }

    const file = fileInput.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      
      // Konversi ke JSON (raw: false agar angka tidak otomatis jadi number jika formatnya text)
      const jsonData = XLSX.utils.sheet_to_json(firstSheet, {raw: false});

      if(jsonData.length === 0) {
        return Swal.fire('Error', 'File kosong atau format salah', 'error');
      }

      // --- TRANSFORMASI DATA ---
      const cleanData = jsonData.map(row => {
        // 1. Ambil Tanggal Lahir (Format Excel biasanya teks/date object, kita harap string YYYY-MM-DD)
        let tglLahir = row['Tanggal Lahir'] || ""; 
        
        // 2. Hitung Umur Otomatis (Abaikan kolom 'Umur' dari Excel)
        let umurHitung = calculateAgeString(tglLahir); 

        // 3. Format Gender (Ambil huruf depan saja, L atau P)
        // Jika di excel "Laki-laki" -> jadi "L", jika "Perempuan" -> jadi "P"
        let rawJK = row['Jenis Kelamin'] || "";
        let fixJK = rawJK.trim().toUpperCase().charAt(0); 
        if(fixJK !== 'L' && fixJK !== 'P') fixJK = ""; 

        // 4. Format No Telepon (Pastikan String dan leading zero aman)
        // Hapus kutip satu (') jika ada user yg input manual pakai kutip di excel
        let rawTelp = row['No Telepon'] || "";
        let fixTelp = rawTelp.toString().replace(/^'/, ""); 

        return {
          nisn: row['NISN'] ? row['NISN'].toString() : "",
          nama: row['Nama Lengkap'] || "",
          nik: row['NIK'] ? row['NIK'].toString() : "",
          tempatLahir: row['Tempat Lahir'] || "",
          tglLahir: tglLahir,
          rombel: row['Tingkat - Rombel'] || "",
          umur: umurHitung,
          status: row['Status'] || "Aktif",
          jk: fixJK,
          alamat: row['Alamat'] || "",
          telp: fixTelp,
          kebKhusus: row['Kebutuhan Khusus'] || "",
          disabilitas: row['Disabilitas'] || "",
          kip: row['Nomor KIP/PIP'] || "",
          ayah: row['Nama Ayah Kandung'] || "",
          ibu: row['Nama Ibu Kandung'] || "",
          wali: row['Nama Wali'] || ""
        };
      });

      // Kirim ke Backend
      sendToBackend(cleanData);
    };

    reader.readAsArrayBuffer(file);
  }

  function sendToBackend(dataSiswa) {
    Swal.fire({
      title: 'Mengimport Data...',
      text: `Memproses ${dataSiswa.length} data siswa. Mohon tunggu.`,
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    const payload = {
      sekolahID: sessionSchoolID,
      data: dataSiswa
    };

    google.script.run.withSuccessHandler(res => {
      Swal.close();
      bootstrap.Modal.getInstance(document.getElementById('importModal')).hide();
      
      if(res.status === 'success') {
        Swal.fire('Berhasil!', res.message, 'success');
        loadAdminData(); // Refresh Tabel Admin
      } else {
        Swal.fire('Gagal', res.message, 'error');
      }
    }).importBulkSiswa(payload);
  }
</script>
