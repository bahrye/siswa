<script>
  let currentNpsn = "";
  let selectedNisn = "";
  let sessionSchoolID = "";
  let globalStudentData = [];

  // --- NAVIGATION & UTILS ---
  function showAdminLogin() {
    document.getElementById('viewLanding').classList.add('d-none');
    document.getElementById('viewPublicList').classList.add('d-none');
    document.getElementById('viewAdminAuth').classList.remove('d-none');
    document.getElementById('btnAdminLink').classList.add('d-none');
  }

  function resetView() {
    document.getElementById('viewLanding').classList.remove('d-none');
    document.getElementById('viewPublicList').classList.add('d-none');
    document.getElementById('viewAdminAuth').classList.add('d-none');
    document.getElementById('btnAdminLink').classList.remove('d-none');
    document.getElementById('inputNpsn').value = "";
    currentNpsn = "";
  }
  
  function toggleAuth(type) {
    if(type==='register'){
       document.getElementById('loginPanel').classList.add('d-none');
       document.getElementById('registerPanel').classList.remove('d-none');
    } else {
       document.getElementById('registerPanel').classList.add('d-none');
       document.getElementById('loginPanel').classList.remove('d-none');
    }
  }

  // Fungsi Hitung Umur untuk Form Input
  function hitungUmur() {
    const dob = document.getElementById('inputTglLahir').value;
    if(dob) {
      const birthDate = new Date(dob);
      const today = new Date();
      let age = today.getFullYear() - birthDate.getFullYear();
      const m = today.getMonth() - birthDate.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
      document.getElementById('inputUmur').value = age;
    }
  }

  // Helper Display Umur (X th, Y bln)
  function calculateAgeString(dobString) {
    if (!dobString) return "-";
    const birthDate = new Date(dobString);
    const today = new Date();
    
    let years = today.getFullYear() - birthDate.getFullYear();
    let months = today.getMonth() - birthDate.getMonth();
    
    if (months < 0 || (months === 0 && today.getDate() < birthDate.getDate())) {
      years--;
      months += 12;
    }
    if (today.getDate() < birthDate.getDate()) {
      months--;
      if(months < 0) months += 12;
    }
    
    return `${years} th, ${months} bln`;
  }
  
  // Helper Filter Umur (Tahun Saja)
  function getAgeYearOnly(dobString) {
     if (!dobString) return 0;
     const birthDate = new Date(dobString);
     const today = new Date();
     let age = today.getFullYear() - birthDate.getFullYear();
     const m = today.getMonth() - birthDate.getMonth();
     if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) age--;
     return age;
  }
  
  // Helper Warna Badge
  function getStatusBadgeClass(status) {
    if (status === 'Aktif') return 'bg-success';
    if (status === 'Lulus') return 'bg-info';
    if (status === 'Pindah') return 'bg-danger';
    return 'bg-secondary'; // Non Aktif
  }

  function logout() {
    Swal.fire({ title: 'Logging out...', timer: 800, didOpen: () => Swal.showLoading() });
    sessionSchoolID = "";
    currentNpsn = "";
    globalStudentData = [];
    
    document.getElementById('viewAdminDashboard').classList.add('d-none');
    document.getElementById('viewAdminAuth').classList.add('d-none'); 
    document.getElementById('viewLanding').classList.remove('d-none');
    document.getElementById('btnLogout').classList.add('d-none');
    document.getElementById('btnAdminLink').classList.remove('d-none');
    
    document.getElementById('username').value = "";
    document.getElementById('password').value = "";
    document.getElementById('adminTableBody').innerHTML = "";
  }

  // --- 1. PUBLIC SEARCH ---
  function searchByNPSN() {
    const npsn = document.getElementById('inputNpsn').value;
    if(!npsn) return Swal.fire('Error','Masukkan NPSN dulu','warning');
    
    Swal.fire({title:'Mencari Sekolah...', didOpen:()=>Swal.showLoading()});
    google.script.run.withSuccessHandler(res => {
      Swal.close();
      if(res.found) {
        currentNpsn = npsn;
        document.getElementById('publicSchoolName').innerText = res.namaSekolah;
        document.getElementById('publicNpsnBadge').innerText = "NPSN: " + npsn;
        renderPublicTable(res.data);
        document.getElementById('viewLanding').classList.add('d-none');
        document.getElementById('viewPublicList').classList.remove('d-none');
      } else {
        Swal.fire('Tidak Ditemukan', res.message, 'error');
      }
    }).getSchoolByNPSN(npsn);
  }

  function renderPublicTable(data) {
    const tbody = document.getElementById('publicTableBody');
    tbody.innerHTML = '';
    if(data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Belum ada data.</td></tr>';
      return;
    }
    data.forEach((row, index) => {
      let badge = getStatusBadgeClass(row.status);
      tbody.innerHTML += `
        <tr>
          <td class="ps-3">${index + 1}</td>
          <td class="fw-bold">${row.nama}</td>
          <td>${row.nisn}</td>
          <td>${row.rombel}</td>
          <td><span class="badge ${badge} status-badge">${row.status}</span></td>
          <td class="text-center">
            <button class="btn btn-sm btn-warning text-white rounded-circle shadow-sm" onclick="promptCode('${row.nisn}')">
              <i class="fas fa-eye"></i>
            </button>
          </td>
        </tr>`;
    });
  }

  // --- 2. SECURE DETAIL VIEW ---
  function promptCode(nisn) {
    selectedNisn = nisn;
    document.getElementById('inputAccessCode').value = "";
    new bootstrap.Modal(document.getElementById('accessCodeModal')).show();
  }

  function verifyCode() {
    const code = document.getElementById('inputAccessCode').value;
    if(code.length < 8) return Swal.fire('Error', 'Kode harus 8 karakter', 'warning');
    bootstrap.Modal.getInstance(document.getElementById('accessCodeModal')).hide();
    Swal.fire({title:'Verifikasi...', didOpen:()=>Swal.showLoading()});
    google.script.run.withSuccessHandler(res => {
      Swal.close();
      if(res.success) showDetailModal(res.data);
      else Swal.fire('Akses Ditolak', res.message, 'error');
    }).verifyAndGetDetail(currentNpsn, selectedNisn, code);
  }

  function showDetailModal(s) {
    let badge = getStatusBadgeClass(s.status);
    const ageDetail = calculateAgeString(s.tglLahir);
    
    const html = `
      <div class="table-responsive">
        <table class="table table-bordered mb-0 align-middle">
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-user me-2"></i>Identitas Pribadi</th></tr></thead>
          <tr><td width="35%" class="text-muted fw-bold ps-3">Nama Lengkap</td><td class="fw-bold fs-5">${s.nama}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">NISN</td><td>${s.nisn}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">NIK</td><td>${s.nik || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Jenis Kelamin</td><td>${s.jk === 'L' ? 'Laki-laki' : 'Perempuan'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">TTL (Umur)</td><td>${s.tempatLahir}, ${s.tglLahir} <br><span class="badge bg-secondary">${ageDetail}</span></td></tr>
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-school me-2"></i>Data Sekolah</th></tr></thead>
          <tr><td class="text-muted fw-bold ps-3">Kelas / Rombel</td><td>${s.rombel}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Status Siswa</td><td><span class="badge ${badge} rounded-pill px-3">${s.status}</span></td></tr>
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-file-medical me-2"></i>Data Tambahan</th></tr></thead>
          <tr><td class="text-muted fw-bold ps-3">Nomor KIP</td><td>${s.kip || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Kebutuhan Khusus</td><td>${s.kebKhusus || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Disabilitas</td><td>${s.disabilitas || '-'}</td></tr>
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-map-marker-alt me-2"></i>Alamat & Kontak</th></tr></thead>
          <tr><td class="text-muted fw-bold ps-3">Alamat Lengkap</td><td>${s.alamat}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">No. Telepon</td><td>${s.telp || '-'}</td></tr>
          
          <thead class="table-light"><tr><th colspan="2" class="text-primary"><i class="fas fa-users me-2"></i>Orang Tua / Wali</th></tr></thead>
          <tr><td class="text-muted fw-bold ps-3">Nama Ayah</td><td>${s.ayah || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Nama Ibu</td><td>${s.ibu || '-'}</td></tr>
          <tr><td class="text-muted fw-bold ps-3">Nama Wali</td><td>${s.wali || '-'}</td></tr>
        </table>
      </div>`;
      
    document.getElementById('detailContent').innerHTML = html;
    new bootstrap.Modal(document.getElementById('detailModal')).show();
  }

  // --- 3. ADMIN LOGIC ---
  function handleLogin(e) {
    e.preventDefault();
    const u = document.getElementById('username').value;
    const p = document.getElementById('password').value;
    Swal.fire({title:'Login...', didOpen:()=>Swal.showLoading()});
    
    google.script.run.withSuccessHandler(res => {
      Swal.close();
      if(res.status === 'success') {
        sessionSchoolID = res.sekolahID;
        document.getElementById('formSekolahID').value = res.sekolahID;
        document.getElementById('dashSchoolName').innerText = res.namaSekolah;
        document.getElementById('dashAccessCode').innerText = res.accessCode;
        
        document.getElementById('viewAdminAuth').classList.add('d-none');
        document.getElementById('viewAdminDashboard').classList.remove('d-none');
        document.getElementById('btnLogout').classList.remove('d-none');
        loadAdminData();
      } else Swal.fire('Gagal', 'Username/Password salah', 'error');
    }).loginAdmin(u, p);
  }

  function handleRegister(e) {
    e.preventDefault();
    Swal.fire({title:'Mendaftarkan...', didOpen:()=>Swal.showLoading()});
    google.script.run.withSuccessHandler(res=>{
      Swal.close();
      if(res.status==='success'){
        Swal.fire('Sukses',res.message,'success');
        document.getElementById('formRegistrasi').reset();
        toggleAuth('login');
      } else Swal.fire('Gagal',res.message,'error');
    }).registrasiSekolah(document.getElementById('formRegistrasi'));
  }

  // --- 4. ADMIN DASHBOARD LOGIC ---

  function loadAdminData() {
    Swal.fire({title:'Memuat Data...', didOpen:()=>Swal.showLoading()});
    google.script.run.withSuccessHandler(data => {
      Swal.close();
      globalStudentData = data;
      
      const uniqueRombel = [...new Set(data.map(item => item.rombel))].sort();
      const selRombel = document.getElementById('filterRombel');
      selRombel.innerHTML = '<option value="">Semua Kelas</option>';
      uniqueRombel.forEach(r => {
        if(r) selRombel.innerHTML += `<option value="${r}">${r}</option>`;
      });

      applyAdminFilter();
    }).getDataSiswa(sessionSchoolID);
  }

  function applyAdminFilter() {
    const fRombel = document.getElementById('filterRombel').value;
    const fStatus = document.getElementById('filterStatus').value; // Ambil Status
    const fJK = document.getElementById('filterJK').value;
    const fMin = document.getElementById('filterUmurMin').value;
    const fMax = document.getElementById('filterUmurMax').value;

    const filtered = globalStudentData.filter(row => {
      const matchRombel = fRombel === "" || row.rombel == fRombel;
      const matchStatus = fStatus === "" || row.status == fStatus; // Logic Filter Status
      const matchJK = fJK === "" || row.jk == fJK;
      
      const umurTahun = getAgeYearOnly(row.tglLahir);
      
      let matchUmur = true;
      if (fMin !== "" && umurTahun < parseInt(fMin)) matchUmur = false;
      if (fMax !== "" && umurTahun > parseInt(fMax)) matchUmur = false;

      return matchRombel && matchStatus && matchJK && matchUmur;
    });

    renderAdminTable(filtered);
    // Kirim data yang sudah difilter ke fungsi summary
    updateSummary(filtered, fRombel, fStatus);
  }

  // --- UPDATE SUMMARY (Total Keseluruhan Sesuai Filter) ---
  function updateSummary(data, rombel, status) {
    // Buat Label yang informatif
    let labelParts = [];
    labelParts.push(rombel ? `Kelas: ${rombel}` : "Semua Kelas");
    if (status) labelParts.push(`Status: ${status}`);
    
    document.getElementById('sumLabelFilter').innerText = "Filter: " + labelParts.join(", ");
    
    // Hitung Jumlah
    const countL = data.filter(d => d.jk === 'L').length;
    const countP = data.filter(d => d.jk === 'P').length;
    
    document.getElementById('sumCountL').innerText = countL;
    document.getElementById('sumCountP').innerText = countP;
    // Ini menampilkan Total Keseluruhan sesuai filter (misal: Kelas 7, Status Aktif -> Totalnya berapa)
    document.getElementById('sumCountTotal').innerText = data.length;
  }

  function renderAdminTable(data) {
    const tbody = document.getElementById('adminTableBody');
    tbody.innerHTML = '';
    
    if(data.length === 0) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">Data tidak ditemukan.</td></tr>';
      document.getElementById('tableCounter').innerText = "";
      return;
    }

    data.forEach(r => {
      let badge = getStatusBadgeClass(r.status);
      const rowJson = encodeURIComponent(JSON.stringify(r));
      const displayAge = calculateAgeString(r.tglLahir);

      tbody.innerHTML += `
        <tr>
          <td>${r.nisn}</td>
          <td class="fw-bold">${r.nama}</td>
          <td>${r.jk}</td>
          <td>${displayAge}</td>
          <td>${r.rombel}</td>
          <td><span class="badge ${badge} status-badge">${r.status}</span></td>
          <td class="text-center">
             <button class="btn btn-sm btn-info text-white rounded-circle me-1" onclick="viewFromAdmin('${rowJson}')" title="Detail">
               <i class="fas fa-eye"></i>
             </button>
             <button class="btn btn-sm btn-warning text-white rounded-circle me-1" onclick="editFromAdmin('${rowJson}')" title="Edit">
               <i class="fas fa-pen"></i>
             </button>
             <button class="btn btn-sm btn-danger rounded-circle" onclick="deleteFromAdmin('${r.nisn}', '${r.nama}')" title="Hapus">
               <i class="fas fa-trash"></i>
             </button>
          </td>
        </tr>`;
    });
    document.getElementById('tableCounter').innerText = `Menampilkan ${data.length} siswa`;
  }

  function viewFromAdmin(jsonStr) {
    const data = JSON.parse(decodeURIComponent(jsonStr));
    showDetailModal(data);
  }

  function deleteFromAdmin(nisn, nama) {
    Swal.fire({
      title: 'Hapus Data?',
      text: `Yakin menghapus siswa: ${nama}?`,
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: 'Ya, Hapus!'
    }).then((result) => {
      if (result.isConfirmed) {
        Swal.fire({title:'Menghapus...', didOpen:()=>Swal.showLoading()});
        google.script.run.withSuccessHandler(res => {
          Swal.close();
          if(res.status === 'success') {
            Swal.fire('Terhapus!', res.message, 'success');
            loadAdminData();
          } else {
            Swal.fire('Gagal', res.message, 'error');
          }
        }).hapusSiswa(sessionSchoolID, nisn);
      }
    });
  }

  function prepareAddModal() {
    document.getElementById('addStudentForm').reset();
    document.getElementById('formMode').value = "add";
    document.getElementById('formSekolahID').value = sessionSchoolID;
    document.querySelector('#addModal .modal-title').innerText = "Input Data Siswa Baru";
    new bootstrap.Modal(document.getElementById('addModal')).show();
  }

  function editFromAdmin(jsonStr) {
    const data = JSON.parse(decodeURIComponent(jsonStr));
    const form = document.getElementById('addStudentForm');
    
    document.getElementById('formMode').value = "edit";
    document.getElementById('oldNisn').value = data.nisn;
    document.getElementById('formSekolahID').value = sessionSchoolID;
    document.querySelector('#addModal .modal-title').innerText = "Edit Data Siswa";

    const keys = Object.keys(data);
    keys.forEach(key => {
       if(form.elements[key]) {
         form.elements[key].value = data[key];
       }
    });
    
    // Trigger update
    hitungUmur();
    const statusSelect = form.elements['status'];
    if(statusSelect) statusSelect.dispatchEvent(new Event('change'));

    new bootstrap.Modal(document.getElementById('addModal')).show();
  }

  function handleSaveStudent(e) {
    e.preventDefault();
    const mode = document.getElementById('formMode').value;
    const modalEl = document.getElementById('addModal');
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    
    modalInstance.hide();
    Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()});
    
    const formEl = document.getElementById('addStudentForm');

    if (mode === 'add') {
       google.script.run.withSuccessHandler(res => {
        Swal.close();
        Swal.fire('Berhasil', res, 'success');
        formEl.reset();
        loadAdminData();
      }).tambahSiswa(formEl);
    } else {
       google.script.run.withSuccessHandler(res => {
        Swal.close();
        Swal.fire('Berhasil Update', res, 'success');
        formEl.reset();
        loadAdminData();
      }).editSiswa(formEl);
    }
  }
</script>
