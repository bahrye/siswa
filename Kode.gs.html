/**
 * APLIKASI DATABASE SISWA MULTI-SEKOLAH
 * File: Kode.gs
 */

function doGet() {
  return HtmlService.createTemplateFromFile('Index')
      .evaluate()
      .setTitle('EduData Pro - Portal Sekolah')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1')
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename)
      .getContent();
}

// --- 1. OTENTIKASI ADMIN ---

function loginAdmin(username, password) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Admin');
  const data = sheet.getDataRange().getValues();
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == username && data[i][1] == password) {
      return { 
        status: 'success', 
        sekolahID: data[i][2], 
        namaSekolah: data[i][3],
        accessCode: data[i][6] || 'BELUM_ADA'
      };
    }
  }
  return { status: 'failed' };
}

function registrasiSekolah(form) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Admin');
  const data = sheet.getDataRange().getValues();
  
  if(form.regNpsn == "" || form.regNama == "" || form.regUser == "" || form.regPass == ""){
    return { status: 'error', message: 'Semua kolom wajib diisi!' };
  }

  for (let i = 1; i < data.length; i++) {
    if (data[i][0] == form.regUser) return { status: 'error', message: 'Username sudah dipakai.' };
    if (data[i][4] == form.regNpsn) return { status: 'error', message: 'NPSN sudah terdaftar.' };
  }

  try {
    const dbName = "DB_SISWA_" + form.regNama + "_" + form.regNpsn;
    const newSS = SpreadsheetApp.create(dbName);
    const newId = newSS.getId();
    
    const newSheet = newSS.getSheets()[0];
    newSheet.setName("DataSiswa");
    const headers = [
      "NISN", "Nama Lengkap", "NIK", "Tempat Lahir", "Tgl Lahir", 
      "Rombel", "Umur", "Status", "JK", "Alamat", 
      "No Telp", "Keb Khusus", "Disabilitas", "No KIP", 
      "Ayah", "Ibu", "Wali", "Created_At"
    ];
    newSheet.appendRow(headers);

    const uniqueID = "SCH-" + new Date().getTime().toString().substr(-6);
    const accessCode = generateRandomCode(8);

    sheet.appendRow([
      form.regUser, form.regPass, uniqueID, form.regNama,
      "'" + form.regNpsn, newId, accessCode
    ]);

    return { status: 'success', message: 'Registrasi Berhasil! Silakan Login.' };

  } catch (e) {
    return { status: 'error', message: 'Gagal: ' + e.toString() };
  }
}

// --- 2. FITUR PUBLIK (NPSN) ---

function getSchoolByNPSN(npsn) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Admin');
  const data = sheet.getDataRange().getValues();
  
  let targetSSId = null;
  let namaSekolah = "";
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][4] == npsn) {
      targetSSId = data[i][5];
      namaSekolah = data[i][3];
      break;
    }
  }
  
  if (!targetSSId) return { found: false, message: "NPSN tidak ditemukan." };
  
  try {
    const db = SpreadsheetApp.openById(targetSSId);
    const rows = db.getSheetByName('DataSiswa').getDataRange().getValues();
    const publicData = [];
    
    for (let i = 1; i < rows.length; i++) {
      publicData.push({
        nisn: rows[i][0],
        nama: rows[i][1],
        rombel: rows[i][5],
        status: rows[i][7],
        jk: rows[i][8],              
        tglLahir: mapDate(rows[i][4]) 
      });
    }
    return { found: true, namaSekolah: namaSekolah, data: publicData };
  } catch(e) {
    return { found: false, message: "Database sekolah tidak dapat diakses." };
  }
}

// --- 3. FITUR DETAIL ---

function verifyAndGetDetail(npsn, nisn, inputCode) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName('Admin');
  const data = sheet.getDataRange().getValues();
  
  let targetSSId = null;
  let correctCode = null;
  
  for (let i = 1; i < data.length; i++) {
    if (data[i][4] == npsn) {
      targetSSId = data[i][5];
      correctCode = data[i][6];
      break;
    }
  }
  
  if (!targetSSId) return { success: false, message: "Sekolah error." };
  
  if (String(inputCode).toUpperCase() !== String(correctCode).toUpperCase()) {
    return { success: false, message: "Kode Akses Salah!" };
  }
  
  try {
    const db = SpreadsheetApp.openById(targetSSId);
    const rows = db.getSheetByName('DataSiswa').getDataRange().getValues();
    
    for (let i = 1; i < rows.length; i++) {
      if (rows[i][0] == nisn) {
        return {
          success: true,
          data: mapStudentRow(rows[i])
        };
      }
    }
    return { success: false, message: "Data siswa tidak ditemukan." };
  } catch(e) {
    return { success: false, message: "Terjadi kesalahan sistem." };
  }
}

// --- 4. CRUD ADMIN ---

function getDataSiswa(sekolahID) {
  const dbId = getSchoolDbId(sekolahID);
  if(!dbId) return [];
  
  try {
    const db = SpreadsheetApp.openById(dbId);
    const rows = db.getSheetByName('DataSiswa').getDataRange().getValues();
    const result = [];
    
    for (let i = 1; i < rows.length; i++) {
      result.push(mapStudentRow(rows[i]));
    }
    return result;
  } catch(e) { return []; }
}

function tambahSiswa(f) {
  const dbId = getSchoolDbId(f.sekolahID);
  if (!dbId) return "Error: Database tidak ditemukan.";

  try {
    const targetSS = SpreadsheetApp.openById(dbId);
    const sheet = targetSS.getSheetByName('DataSiswa');
    
    // UPDATE: Menambahkan kutip satu (') pada NISN, NIK, dan Telp
    sheet.appendRow([
      "'" + f.nisn,             // Kolom 1: NISN
      f.nama,                   // Kolom 2: Nama
      "'" + f.nik,              // Kolom 3: NIK
      f.tempatLahir, 
      f.tglLahir,
      f.rombel, 
      f.umur, 
      f.status, 
      f.jk, 
      f.alamat, 
      "'" + f.telp,             // Kolom 11: No Telp (FORMAT TEKS)
      f.kebKhusus, 
      f.disabilitas, 
      f.kip, 
      f.ayah, 
      f.ibu, 
      f.wali, 
      new Date()
    ]);
    return "Data Siswa Berhasil Disimpan!";
  } catch(e) { return "Gagal menyimpan: " + e.message; }
}

function hapusSiswa(sekolahID, nisn) {
  const dbId = getSchoolDbId(sekolahID);
  if (!dbId) return {status:'error', message: "Database tidak ditemukan."};

  try {
    const targetSS = SpreadsheetApp.openById(dbId);
    const sheet = targetSS.getSheetByName('DataSiswa');
    const data = sheet.getDataRange().getValues();
    
    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) == String(nisn)) {
        sheet.deleteRow(i + 1); 
        return {status: 'success', message: "Data berhasil dihapus!"};
      }
    }
    return {status: 'error', message: "NISN tidak ditemukan."};
  } catch(e) { return {status: 'error', message: "Gagal: " + e.message}; }
}

function editSiswa(f) {
  const dbId = getSchoolDbId(f.sekolahID);
  if (!dbId) return "Error: Database tidak ditemukan.";

  try {
    const targetSS = SpreadsheetApp.openById(dbId);
    const sheet = targetSS.getSheetByName('DataSiswa');
    const data = sheet.getDataRange().getValues();
    
    const searchKey = f.oldNisn || f.nisn;

    for (let i = 1; i < data.length; i++) {
      if (String(data[i][0]) == String(searchKey)) {
        const rowNum = i + 1;
        
        // UPDATE: Menambahkan kutip satu (') pada NISN, NIK, dan Telp
        const updatedRow = [
          "'" + f.nisn,          // Kolom 1
          f.nama, 
          "'" + f.nik,           // Kolom 3
          f.tempatLahir, 
          f.tglLahir,
          f.rombel, 
          f.umur, 
          f.status, 
          f.jk, 
          f.alamat, 
          "'" + f.telp,          // Kolom 11 (FORMAT TEKS)
          f.kebKhusus, 
          f.disabilitas, 
          f.kip, 
          f.ayah, 
          f.ibu, 
          f.wali, 
          new Date()
        ];
        sheet.getRange(rowNum, 1, 1, updatedRow.length).setValues([updatedRow]);
        return "Data Berhasil Diperbarui!";
      }
    }
    return "Data tidak ditemukan untuk diedit.";
  } catch(e) { return "Gagal update: " + e.message; }
}

// --- 5. FUNGSI IMPORT EXCEL ---

function importBulkSiswa(payload) {
  const sekolahID = payload.sekolahID;
  const dataSiswa = payload.data;
  
  if (!dataSiswa || dataSiswa.length === 0) return {status: 'error', message: "Data kosong."};

  const dbId = getSchoolDbId(sekolahID);
  if (!dbId) return {status: 'error', message: "Database sekolah tidak ditemukan."};

  try {
    const targetSS = SpreadsheetApp.openById(dbId);
    const sheet = targetSS.getSheetByName('DataSiswa');
    
    // Siapkan Array 2D untuk insert sekaligus
    const rowsToAdd = dataSiswa.map(s => {
      return [
        "'" + s.nisn,      // Col 1: NISN (Text)
        s.nama,
        "'" + s.nik,       // Col 3: NIK (Text)
        s.tempatLahir,
        s.tglLahir,
        s.rombel,
        s.umur,
        s.status,
        s.jk,
        s.alamat,
        "'" + s.telp,      // Col 11: No Telp (Text)
        s.kebKhusus,
        s.disabilitas,
        s.kip,
        s.ayah,
        s.ibu,
        s.wali,
        new Date()
      ];
    });

    const lastRow = sheet.getLastRow();
    sheet.getRange(lastRow + 1, 1, rowsToAdd.length, rowsToAdd[0].length).setValues(rowsToAdd);
    
    return {
      status: 'success', 
      message: `Berhasil mengimport ${rowsToAdd.length} siswa.`
    };

  } catch (e) {
    return {status: 'error', message: "Gagal import: " + e.message};
  }
}

// Helpers
function getSchoolDbId(sekolahID) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const rows = ss.getSheetByName('Admin').getDataRange().getValues();
  for(let i=1; i<rows.length; i++){
    if(rows[i][2] == sekolahID) return rows[i][5];
  }
  return null;
}

function mapStudentRow(row) {
  return {
    nisn: row[0], nama: row[1], nik: row[2],
    tempatLahir: row[3], tglLahir: mapDate(row[4]),
    rombel: row[5], umur: row[6], status: row[7],
    jk: row[8], alamat: row[9], telp: row[10],
    kebKhusus: row[11], disabilitas: row[12], kip: row[13],
    ayah: row[14], ibu: row[15], wali: row[16]
  };
}

function generateRandomCode(length) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
  let result = '';
  for (let i = 0; i < length; i++) {
    result += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return result;
}

function mapDate(dateObj) {
  if (!dateObj) return "";
  try {
    const d = new Date(dateObj);
    const offset = d.getTimezoneOffset();
    const yourDate = new Date(d.getTime() - (offset*60*1000));
    return yourDate.toISOString().split('T')[0];
  } catch(e) { return dateObj; }
}
